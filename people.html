<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Apple Photos Peoples Ridgeline</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<link rel="stylesheet" href="css/main.css" />
<style>
body { padding-bottom: 3em; }
#people-graph canvas {
    margin-right: 1em;
    /* border: 1px solid red; */
}
#people-graph {
    box-shadow: rgba(0, 0, 0, 0.4) 0px 2px 4px, rgba(0, 0, 0, 0.3) 0px 7px 13px -3px, rgba(0, 0, 0, 0.2) 0px -3px 0px inset;
    overflow-x: scroll;
    padding: 2em 1em;
}
</style>
</head>
<body>
<div class="container-fluid">
    <div class="header-nav"></div>
    <div id="people-graph"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/p5.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
<script>
let peopleData;
let canvas;

$(document).ready(() => {
    $('.header-nav').load('navigation.html', ()=> {
        $('#nav-people-ridgeline').addClass('active');
    });

    $.ajax({
        type: "GET",
        url: "outdata/people_data.json",
        success: function (data) {
            peopleData = data;

            // Sort by total
            peopleData.series.sort((a, b) => (a.total < b.total) ? 1 : ((b.total < a.total) ? -1 : 0))


            console.log(data);
            startRender();
        }
    });
});

// Global properties
const g = {
    bg_color: "#fff",
    border_width: 0,
    border_color: "#888",
    row_height: 16,
    date_width: 1/5,
    grid_color: "#ccc",
    name_margin: 140,
    padding: 0,
    dotsize: 5,
    line_color_dark: "#000",
    line_color_light: "#6baed6",
};

function calculateCanvasWidth(data_width) {
    return data_width * g.date_width + 2 * 
    (g.border_width + g.padding) + g.name_margin;
}

function calculateCanvasHeight(data_height) {
    return (data_height + 1) * g.row_height + 2 * (
        g.border_width + g.padding
    );
}

function mapDataIndexToScreenCoords(date_index, person_index) {
    return {
        x: date_index * g.date_width,
        y: g.row_height * (person_index + 1)
    };
}

function startRender() {

    const date_size = peopleData.dates.length;
    const people_size = peopleData.series.length;
    console.log("Data loaded with " + date_size + " dates and " + people_size + " people");

    function drawBorder(p) {
        // p.stroke(g.border_color);
        // p.strokeWeight(1);
        // p.noFill();
        // p.rect(g.padding, g.padding, date_size, people_size);
    }

    function drawGrid(p) {
        p.push();
        p.translate(g.padding, g.padding);

        // Draw horizontal grid lines
        p.stroke(g.grid_color);
        for (let i = 0; i < peopleData.series.length; i++) {
            const y = mapDataIndexToScreenCoords(0, i).y;
            p.line(0, y, p.width - 2 * g.padding, y);
        }
        
        p.noStroke();
        p.fill(255, 150);
        p.rect(0, 0, g.name_margin, p.height - 2 * g.padding);
        
        // Draw starting vertical line
        p.stroke(g.grid_color);
        p.line(g.name_margin, 0, g.name_margin, p.height - 2 * g.padding)

        p.pop();   
    }

    function drawNames(p) {
        p.push();
        p.translate(g.padding, g.padding);
        p.fill(0);
        p.noStroke();
        p.textAlign(p.LEFT, p.CENTER);
        for (let i = 0; i < peopleData.series.length; i++) {
            const name = peopleData.series[i].name + " (" + peopleData.series[i].total + ")";
            p.text(name, g.padding, mapDataIndexToScreenCoords(0, i).y);
        }
        p.pop();
    }

    const plotType = 'barcode';

    function plotPeopleData(p) {
        p.push();
        p.translate(g.padding + g.name_margin, g.padding);

        if (plotType === 'barcode') {
            p.strokeWeight(1);
            for (let i = 0; i < peopleData.series.length; i++) {
                const name = peopleData.series[i].name;
                const personData = peopleData.series[i].values;

                for (let j = 0; j < personData.length; j++) {
                    const value = personData[j];
                    if (value == 0) {
                        continue;
                    }

                    let plot_pos = mapDataIndexToScreenCoords(j, i);
                    p.stroke(p.lerpColor(
                        p.color(g.line_color_light), p.color(g.line_color_dark), p.constrain(
                            p.map(value, 0, 50, 0, 1), 0, 1)));
                    const dy = 0.5 * g.row_height;
                    p.line(plot_pos.x, plot_pos.y - dy, plot_pos.x, plot_pos.y + dy);
                }
            }
        } else if (plotType === 'dot') {
            p.noStroke();
            p.blendMode(p.MULTIPLY);
            p.fill(p.color(g.line_color_light), 10);
            for (let i = 0; i < peopleData.series.length; i++) {
                const name = peopleData.series[i].name;
                const personData = peopleData.series[i].values;

                for (let j = 0; j < personData.length; j++) {
                    const value = personData[j];
                    if (value == 0) {
                        continue;
                    }

                    const plot_pos = mapDataIndexToScreenCoords(j, i);
                    const size = g.dotsize + Math.log(value + 1);
                    p.ellipse(plot_pos.x, plot_pos.y, size, size);
                }
            }
        }
        
        p.pop();
    }

    const sketch = (p)=> {

        // Setup canvas size from data size
        p.setup = ()=> {
            
            // Calculate canvas size based on config
            const canvas_width = calculateCanvasWidth(date_size);
            const canvas_height = calculateCanvasHeight(people_size);

            p.createCanvas(canvas_width, canvas_height);
            p.noLoop();
            
            // Draw border and clear screen
            p.background(g.bg_color);
            

        }

        p.draw = ()=> {
            drawBorder(p);
            plotPeopleData(p);
            drawGrid(p);
            drawNames(p);
        }
    }

    let myp5 = new p5(sketch, document.getElementById('people-graph'));
}


</script>
</body>
</html>